name: Release
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build installers for (e.g., v0.10.0-beta.1)'
        required: true
        type: string
permissions:
  contents: write
jobs:
  # ---------------------------------------------------------------------------
  # Prepare: prerelease detection and branch validation
  # ---------------------------------------------------------------------------
  prepare:
    if: github.event_name != 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      is_prerelease: ${{ steps.check-prerelease.outputs.is_prerelease }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0

      - name: Check if prerelease
        id: check-prerelease
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          if [[ "$VERSION" == *"-beta"* || "$VERSION" == *"-alpha"* || "$VERSION" == *"-rc"* ]]; then
            echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Check branch for beta releases
        if: steps.check-prerelease.outputs.is_prerelease == 'true'
        env:
          GIT_REF: ${{ github.ref }}
        run: |
          TAG_COMMIT=$(git rev-parse "$GIT_REF")
          echo "Tag commit: $TAG_COMMIT"
          BRANCH_CONTAINS=$(git branch -r --contains "$TAG_COMMIT" | grep -E "origin/(develop|feature/)" || true)
          echo "Branch contains check: $BRANCH_CONTAINS"
          if [[ -n "$BRANCH_CONTAINS" ]]; then
            echo "Tag is on a valid branch for beta releases"
          else
            echo "Beta releases should only be created from develop or feature branches"
            exit 1
          fi

  # ---------------------------------------------------------------------------
  # Docker: Build Bun image per-platform with native runners (no QEMU)
  # ---------------------------------------------------------------------------
  docker-bun:
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-latest
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Prepare
        env:
          PLATFORM: ${{ matrix.platform }}
        run: echo "PLATFORM_PAIR=${PLATFORM//\//-}" >> "$GITHUB_ENV"

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5
        with:
          images: lakker/pulsarr

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Login to Docker Hub
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@601a80b39c9405e50806ae38af30926f9d957c47 # v6
        with:
          context: .
          platforms: ${{ matrix.platform }}
          labels: ${{ steps.meta.outputs.labels }}
          # Note: TMDB API key is intentionally included in the image for user convenience
          # Users building from source should provide their own key
          build-args: |
            TMDBAPIKEY=${{ secrets.TMDBAPIKEY }}
          outputs: type=image,name=lakker/pulsarr,push-by-digest=true,name-canonical=true,push=true
          cache-from: type=gha,scope=bun-${{ env.PLATFORM_PAIR }}
          cache-to: type=gha,mode=max,scope=bun-${{ env.PLATFORM_PAIR }}

      - name: Export digest
        run: |
          mkdir -p /tmp/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "/tmp/digests/${digest#sha256:}"

      - name: Upload digest
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: digests-bun-${{ env.PLATFORM_PAIR }}
          path: /tmp/digests/*
          if-no-files-found: error
          retention-days: 1

  # ---------------------------------------------------------------------------
  # Docker: Merge Bun platform images into multi-arch manifest
  # ---------------------------------------------------------------------------
  docker-bun-manifest:
    needs: [prepare, docker-bun]
    runs-on: ubuntu-latest
    steps:
      - name: Download digests
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          pattern: digests-bun-*
          merge-multiple: true
          path: /tmp/digests

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5
        with:
          images: lakker/pulsarr
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable=${{ needs.prepare.outputs.is_prerelease != 'true' }}
            type=raw,value=beta,enable=${{ needs.prepare.outputs.is_prerelease == 'true' }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Login to Docker Hub
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Create manifest list and push
        working-directory: /tmp/digests
        run: |
          docker buildx imagetools create \
            $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf 'lakker/pulsarr@sha256:%s ' *)

      - name: Inspect image
        run: docker buildx imagetools inspect "lakker/pulsarr:${{ steps.meta.outputs.version }}"

  # ---------------------------------------------------------------------------
  # Docker: Build Node.js image per-platform with native runners (no QEMU)
  # ---------------------------------------------------------------------------
  docker-node:
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-latest
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Prepare
        env:
          PLATFORM: ${{ matrix.platform }}
        run: echo "PLATFORM_PAIR=${PLATFORM//\//-}" >> "$GITHUB_ENV"

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5
        with:
          images: lakker/pulsarr

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Login to Docker Hub
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@601a80b39c9405e50806ae38af30926f9d957c47 # v6
        with:
          context: .
          file: dockerfile.node
          platforms: ${{ matrix.platform }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            TMDBAPIKEY=${{ secrets.TMDBAPIKEY }}
          outputs: type=image,name=lakker/pulsarr,push-by-digest=true,name-canonical=true,push=true
          cache-from: type=gha,scope=node-${{ env.PLATFORM_PAIR }}
          cache-to: type=gha,mode=max,scope=node-${{ env.PLATFORM_PAIR }}

      - name: Export digest
        run: |
          mkdir -p /tmp/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "/tmp/digests/${digest#sha256:}"

      - name: Upload digest
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: digests-node-${{ env.PLATFORM_PAIR }}
          path: /tmp/digests/*
          if-no-files-found: error
          retention-days: 1

  # ---------------------------------------------------------------------------
  # Docker: Merge Node.js platform images into multi-arch manifest
  # ---------------------------------------------------------------------------
  docker-node-manifest:
    needs: [prepare, docker-node]
    runs-on: ubuntu-latest
    steps:
      - name: Download digests
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          pattern: digests-node-*
          merge-multiple: true
          path: /tmp/digests

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5
        with:
          images: lakker/pulsarr
          flavor: |
            latest=false
          tags: |
            type=semver,pattern={{version}},suffix=-node
            type=semver,pattern={{major}}.{{minor}},suffix=-node
            type=raw,value=node,enable=${{ needs.prepare.outputs.is_prerelease != 'true' }}
            type=raw,value=beta-node,enable=${{ needs.prepare.outputs.is_prerelease == 'true' }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Login to Docker Hub
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Create manifest list and push
        working-directory: /tmp/digests
        run: |
          docker buildx imagetools create \
            $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf 'lakker/pulsarr@sha256:%s ' *)

      - name: Inspect image
        run: docker buildx imagetools inspect "lakker/pulsarr:${{ steps.meta.outputs.version }}"

  # ---------------------------------------------------------------------------
  # Release: Native builds + GitHub Release (runs parallel with Docker jobs)
  # ---------------------------------------------------------------------------
  release:
    needs: prepare
    if: github.event_name != 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Set up Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version-file: ".bun-version"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build native packages
        run: bun run build:native -- --all
        env:
          TMDBAPIKEY: ${{ secrets.TMDBAPIKEY }}

      - name: Create Draft Release
        uses: release-drafter/release-drafter@6db134d15f3909ccc9eefd369f02bd1e9cffdf97 # v6
        with:
          config-name: release-drafter.yml
          tag: ${{ github.ref_name }}
          prerelease: ${{ needs.prepare.outputs.is_prerelease == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Native Builds to Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ github.ref_name }}" native-build/*.zip --clobber

  # ---------------------------------------------------------------------------
  # Installers: Windows (needs native builds uploaded to release)
  # ---------------------------------------------------------------------------
  build-windows-installer:
    needs: release
    runs-on: windows-latest
    # Run after release job succeeds, or run standalone when manually triggered
    if: ${{ always() && (needs.release.result == 'success' || github.event_name == 'workflow_dispatch') }}
    strategy:
      matrix:
        include:
          - variant: standard
            zip_pattern: "*windows-x64.zip"
            iss_file: pulsarr.iss
          - variant: baseline
            zip_pattern: "*windows-x64-baseline.zip"
            iss_file: pulsarr-baseline.iss
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Get version
        id: version
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_TAG: ${{ github.event.inputs.tag }}
        run: |
          if [ "$EVENT_NAME" == "workflow_dispatch" ]; then
            VERSION="$INPUT_TAG"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "version_number=${VERSION#v}" >> "$GITHUB_OUTPUT"

      - name: Download Windows ${{ matrix.variant }} zip from release
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_VERSION: ${{ steps.version.outputs.version }}
        run: |
          gh release download "$RELEASE_VERSION" \
            --pattern "${{ matrix.zip_pattern }}" \
            --dir scripts/installers/windows

      - name: Extract zip
        shell: pwsh
        run: |
          $zip = Get-ChildItem scripts/installers/windows/*.zip | Select-Object -First 1
          Expand-Archive -Path $zip.FullName -DestinationPath scripts/installers/windows/extracted
          # Move contents from nested folder to build/
          $nested = Get-ChildItem scripts/installers/windows/extracted | Select-Object -First 1
          New-Item -ItemType Directory -Force -Path scripts/installers/windows/build
          Move-Item "$($nested.FullName)/*" scripts/installers/windows/build/
          Remove-Item scripts/installers/windows/extracted -Recurse
          Remove-Item $zip.FullName

      - name: Build installer with Inno Setup
        shell: pwsh
        env:
          APP_VERSION: ${{ steps.version.outputs.version_number }}
        run: |
          # Inno Setup is pre-installed on windows-latest
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" `
            /DMyAppVersion=$env:APP_VERSION `
            scripts/installers/windows/${{ matrix.iss_file }}

      - name: Upload installer to release
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_VERSION: ${{ steps.version.outputs.version }}
        run: |
          gh release upload "$RELEASE_VERSION" \
            scripts/installers/windows/Output/*.exe \
            --clobber

  # ---------------------------------------------------------------------------
  # Installers: macOS (needs native builds uploaded to release)
  # ---------------------------------------------------------------------------
  build-macos-installer:
    needs: release
    runs-on: macos-latest
    # Run after release job succeeds, or run standalone when manually triggered
    if: ${{ always() && (needs.release.result == 'success' || github.event_name == 'workflow_dispatch') }}
    strategy:
      matrix:
        arch: [x64, arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Get version
        id: version
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_TAG: ${{ github.event.inputs.tag }}
        run: |
          if [ "$EVENT_NAME" == "workflow_dispatch" ]; then
            VERSION="$INPUT_TAG"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Download macOS zip from release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_VERSION: ${{ steps.version.outputs.version }}
          ARCH: ${{ matrix.arch }}
        run: |
          gh release download "$RELEASE_VERSION" \
            --pattern "*macos-${ARCH}.zip" \
            --dir .

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Extract and build .app bundle
        env:
          RELEASE_VERSION: ${{ steps.version.outputs.version }}
          ARCH: ${{ matrix.arch }}
        run: |
          # Extract the native build zip
          unzip -q "pulsarr-"*"-macos-${ARCH}.zip"

          # Enter the extracted directory
          cd "pulsarr-"*"-macos-${ARCH}"

          # Run the build script
          ../scripts/installers/macos/build-app.sh "$RELEASE_VERSION" "$ARCH"

          # Move output to workspace root
          mv pulsarr-*.dmg ../

      - name: Upload installer to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_VERSION: ${{ steps.version.outputs.version }}
          ARCH: ${{ matrix.arch }}
        run: |
          gh release upload "$RELEASE_VERSION" \
            "pulsarr-"*"-macos-${ARCH}.dmg" \
            --clobber
